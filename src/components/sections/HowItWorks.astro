---
/**
 * How It Works Section with GSAP ScrollTrigger Pin Effect
 * The section gets pinned while content scrolls through
 */

import SectionHeader from '../ui/SectionHeader.astro';

const steps = [
  {
    number: '01',
    title: 'Prenez rendez-vous en ligne',
    description: 'Choisissez le créneau qui vous convient dans mon agenda en ligne. Simple, rapide et flexible.',
    icon: 'calendar',
  },
  {
    number: '02',
    title: 'Recevez votre lien de connexion',
    description: 'Un email de confirmation avec le lien sécurisé vous est envoyé. Aucune installation requise.',
    icon: 'mail',
  },
  {
    number: '03',
    title: 'Connectez-vous à l\'heure du RDV',
    description: 'Installez-vous confortablement chez vous et rejoignez la consultation vidéo en toute confidentialité.',
    icon: 'video',
  },
  {
    number: '04',
    title: 'Commencez votre accompagnement',
    description: 'Ensemble, nous définissons vos objectifs et construisons votre parcours thérapeutique personnalisé.',
    icon: 'heart',
  },
];

const icons: Record<string, string> = {
  calendar: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />`,
  mail: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`,
  video: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />`,
  heart: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />`,
};
---

<section id="how-it-works" class="section-lavande">
  <div class="container">
    <SectionHeader
      badge="Comment ça marche"
      title="Votre consultation en 4 étapes"
      subtitle="Un processus simple et sécurisé pour démarrer votre accompagnement en ligne."
    />

    <!-- Pin Section Container -->
    <div class="pin-wrapper relative" data-pin-section>
      <div class="grid lg:grid-cols-2 gap-12 lg:gap-20 items-start">
        <!-- Left: Illustration (gets pinned) -->
        <div class="pin-visual lg:sticky lg:top-32 self-start" data-pin-visual>
          <div class="relative max-w-md mx-auto">
            <!-- Main illustration - hands connected to brain -->
            <div class="relative bg-gradient-to-br from-bg-warm to-bg-lavande rounded-3xl p-8 shadow-xl">
              <img
                src="/images/illustrations/hands-brain.webp"
                alt="Illustration de mains connectées à un cerveau - symbolisant le processus thérapeutique"
                class="w-full h-auto"
                loading="lazy"
              />

              <!-- Step number overlay -->
              <div class="absolute top-4 right-4 w-16 h-16 rounded-full bg-white shadow-lg flex items-center justify-center">
                <span
                  class="step-number text-3xl font-heading font-bold text-secondary transition-all duration-300"
                  data-step-number
                >01</span>
              </div>
            </div>

            <!-- Progress indicator -->
            <div class="flex justify-center gap-2 mt-6">
              {steps.map((_, index) => (
                <div
                  class="step-dot w-3 h-3 rounded-full bg-slate/20 transition-all duration-300"
                  data-step-dot={index}
                />
              ))}
            </div>
          </div>
        </div>

        <!-- Right: Steps (scroll through) -->
        <div class="pin-steps space-y-8" data-pin-steps>
          {steps.map((step, index) => (
            <div
              class="step-card bg-white rounded-2xl p-8 shadow-md transition-all duration-500 opacity-50 scale-95"
              data-step-card={index}
            >
              <div class="flex items-start gap-6">
                <div class="flex-shrink-0 w-16 h-16 rounded-2xl bg-bg-lavande flex items-center justify-center">
                  <span class="text-2xl font-heading font-bold text-slate">{step.number}</span>
                </div>
                <div>
                  <h3 class="text-xl font-heading font-medium mb-2">{step.title}</h3>
                  <p class="text-text-light leading-relaxed">{step.description}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Wait for DOM
  document.addEventListener('DOMContentLoaded', () => {
    const pinSection = document.querySelector('[data-pin-section]');
    const stepCards = document.querySelectorAll('[data-step-card]');
    const stepNumber = document.querySelector('[data-step-number]');
    const stepDots = document.querySelectorAll('[data-step-dot]');

    if (!pinSection || stepCards.length === 0) return;

    const stepNumbers = ['01', '02', '03', '04'];

    // Set initial state - first step active
    stepCards[0]?.classList.remove('opacity-50', 'scale-95');
    stepCards[0]?.classList.add('opacity-100', 'scale-100');
    stepDots[0]?.classList.add('bg-secondary', 'scale-125');

    // Create scroll triggers for each step
    stepCards.forEach((card, index) => {
      ScrollTrigger.create({
        trigger: card,
        start: 'top center',
        end: 'bottom center',
        onEnter: () => activateStep(index),
        onEnterBack: () => activateStep(index),
      });
    });

    function activateStep(activeIndex: number) {
      // Update cards
      stepCards.forEach((card, index) => {
        if (index === activeIndex) {
          card.classList.remove('opacity-50', 'scale-95');
          card.classList.add('opacity-100', 'scale-100');
        } else {
          card.classList.add('opacity-50', 'scale-95');
          card.classList.remove('opacity-100', 'scale-100');
        }
      });

      // Update step number
      if (stepNumber) {
        gsap.to(stepNumber, {
          scale: 0.8,
          opacity: 0,
          duration: 0.15,
          onComplete: () => {
            stepNumber.textContent = stepNumbers[activeIndex];
            gsap.to(stepNumber, {
              scale: 1,
              opacity: 1,
              duration: 0.15,
            });
          },
        });
      }

      // Update dots
      stepDots.forEach((dot, index) => {
        if (index === activeIndex) {
          dot.classList.add('bg-secondary', 'scale-125');
          dot.classList.remove('bg-slate/20');
        } else {
          dot.classList.remove('bg-secondary', 'scale-125');
          dot.classList.add('bg-slate/20');
        }
      });
    }
  });
</script>

<style>
  .step-illustration {
    pointer-events: none;
  }

  .step-card {
    will-change: transform, opacity;
  }

  /* Make first illustration visible by default */
  [data-step-illustration="0"] {
    opacity: 1;
  }
</style>
